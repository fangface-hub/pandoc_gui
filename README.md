# Pandoc GUI

[日本語](README.ja.md) | [Deutsch](README.de.md) | [中文](README.zh.md) | [Français](README.fr.md) | [Italiano](README.it.md) | [한국어](README.ko.md)

A simple GUI frontend for Pandoc that generates diagrams (Mermaid, PlantUML, etc.) using Lua filters. Designed for use on Windows.

## Features

- File/folder selection and output destination settings
- Apply Lua filters (preset + user-added) from the `filters/` directory
- CSS style settings (in `stylesheets/` directory), choose between embed or external link
- Save/load profiles (`profiles/*.json`)
- Log output (GUI and `pandoc.log`)
- Run Pandoc in background, safely terminate child processes on app exit

## Requirements

- Python 3.8+
- Pandoc (add to PATH)
- For Mermaid: `mmdc` (mermaid-cli)
- For PlantUML: `plantuml.jar` and Java (jdk/jre)
- (Optional) Required Lua filters (`filters/*.lua`)

## How to Run

1. Install required tools (Pandoc, Node/mmdc, Java, etc.)
2. Run from the repository root:

    ```powershell
    python main_window.py
    ```

## Specifying PlantUML / Java Paths

Specify the PlantUML JAR and Java executable using these methods (in priority order):

- PlantUML JAR: Document YAML metadata `plantuml_jar` → Environment variable `PLANTUML_JAR` → `plantuml.jar`
- Java executable: Document YAML metadata `java_path` → Environment variable `JAVA_PATH` → `JAVA_HOME\bin\java` → `java` (PATH)

Windows environment variable example (Command Prompt):

```bat
set PLANTUML_JAR=C:\path\to\plantuml.jar
set JAVA_PATH=C:\path\to\java.exe
```

PowerShell:

```powershell
$env:PLANTUML_JAR = 'C:\path\to\plantuml.jar'
$env:JAVA_PATH = 'C:\path\to\java.exe'
```

Example YAML specification in document:

```yaml
---
plantuml_jar: C:\path\to\plantuml.jar
java_path: C:\path\to\java.exe
---
```

## How to Use (GUI)

1. Select input with "File Selection" or "Folder Selection"
2. Select output directory with "Output Destination Selection"
3. Add preset/user filters (adjust order with up/down buttons)
4. (Optional) Configure exclusion patterns to skip specific files during folder conversion
5. Click "Run Conversion"

### Exclusion Pattern Settings

When batch converting folders, you can exclude specific files or folders:

- Click "Exclusion Pattern Management" to open settings
- Wildcard patterns supported (e.g., `*.tmp`, `__pycache__`, `.git`)
- Multiple patterns supported (one per line)

Pattern Matching Examples:

- `*.tmp` - Exclude all .tmp files
- `__pycache__` - Exclude __pycache__ folders and contents
- `.git` - Exclude .git folders
- `test_*` - Exclude files starting with test_
- `*_backup` - Exclude files ending with _backup

## Logs & Profiles

- The GUI displays logs, and the system records details in `pandoc.log`
- The system saves profiles as JSON in the `profiles/` directory

## Creating Distribution Packages

### Create Folder Distribution with PyInstaller

1. Install PyInstaller:

    ```powershell
    pip install pyinstaller
    ```

2. Create executable:

    __Note__: `PandocGUI.spec` is included in the repository with post-build processing configured to place `filters/` and `locales/` outside `_internal/`.

    ```powershell
    python -m PyInstaller PandocGUI.spec
    ```

    Only if you need to regenerate the `.spec` file (normally not required):

    ```powershell
    pyinstaller --noconsole --onedir --name "PandocGUI" `
      --add-data "locales;locales" `
      --add-data "filters;filters" `
      --add-data "stylesheets;stylesheets" `
      main_window.py
    ```

    __Important__: You must manually add post-build processing to the `.spec` file generated by the above command.

3. Build output is in `dist/PandocGUI/`:

    ```text
    dist/PandocGUI/
    ├── PandocGUI.exe        # Executable
    ├── filters/             # Lua filters
    ├── locales/             # Translation files
    ├── stylesheets/         # CSS stylesheets
    ├── help/                # Help files (HTML)
    ├── profiles/            # Profiles (created at runtime)
    └── _internal/           # Python dependencies
    ```

    The post-build processing in the `.spec` file places `filters/`, `locales/`, and `stylesheets/` outside `_internal/`

### Create Windows Installer with MSIX Packaging Tool

1. Install MSIX Packaging Tool:

   - Install "MSIX Packaging Tool" from Microsoft Store

2. Launch MSIX Packaging Tool and select "Application package"

3. Select "Create package on this computer"

4. Enter package information:

    - Package name: `PandocGUI`
    - Publisher: `CN=YourName` (Change according to certificate)
    - Version: `1.0.0.0`

5. Select installer:

    - Click "Browse" and select `dist/PandocGUI/PandocGUI.exe`
    - Installation location: `C:\Program Files\PandocGUI`

6. Execute installation and capture:

   - Launch app and verify operation
   - Verify all required files are included
   - Click "Done"

7. Save package:

    - Save as .msix file

8. Signing (optional):

    - Create test certificate or use existing certificate

    ```powershell
    # Create test certificate
    New-SelfSignedCertificate -Type Custom -Subject "CN=YourName" `
      -KeyUsage DigitalSignature -FriendlyName "PandocGUI Test Certificate" `
      -CertStoreLocation "Cert:\CurrentUser\My" `
      -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
    
    # Sign MSIX file
    SignTool sign /fd SHA256 /a /f certificate.pfx /p password PandocGUI.msix
    ```

9. Distribute installer:

   - Distribute .msix file
   - Users install certificate before installing app

### Notes

- Verify that resource files like `filters/` and `locales/` are properly included
- External tools like Pandoc, mmdc, and Java need to be installed separately
- MSIX packages require signing (test certificates can be used during development)

## Testing

We provide unit tests. Run them with the following commands:

### Run All Tests

```powershell
python -m unittest discover -s . -p "test_*.py"
```

### Run Individual Test Files

```powershell
python -m unittest test_<name>.py
```

Example:

```powershell
python -m unittest test_main_window.py
```

### Verbose Test Output

```powershell
python -m unittest discover -v
```

Test Files:

- `test_main_window.py` - Main window and profile management features
- `test_css_window.py` - CSS settings features
- `test_filter_window.py` - Filter management features
- `test_log_window.py` - Log display features

## Troubleshooting

- If the system cannot find PlantUML or cannot execute Java, a message will appear in stderr. Specify the path using environment variables or YAML metadata.
- The system displays Pandoc errors in the GUI log and `pandoc.log`.

## Development Notes

- We locate Lua filters in the `filters/` directory (e.g., `filters/diagram.lua`).
- We locate CSS files in the `stylesheets/` directory. You can select them from the GUI and apply them as embedded or external links.
- The system performs conversion in a background thread, and terminates/kills child processes on app exit.
